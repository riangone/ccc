@* ファイル概要: 動的CRUDのメイン画面。検索・フィルタ・一覧領域を構成します。
   このビューは画面表示と操作導線を担当します。
   データバインディング名や hx-* 属性を変更する場合は、コントローラ側との整合を必ず確認してください。 *@

@using DynamicCrudSample.Models
@model DynamicCrudSample.Controllers.DynamicListViewModel
@{
    var title = Model.Meta.GetDisplayName();
    ViewData["Title"] = title;
    ViewBag.ForeignKeyData = Model.ForeignKeyData;
    var filterCols = Math.Clamp(Model.Meta.Layout.Filters.Columns, 1, 6);
    var filterColClass = $"md:grid-cols-{filterCols}";
    var orderedFilters = Model.Meta.GetOrderedFilters().ToList();
    IReadOnlyList<BreadcrumbItem> breadcrumbs = Model.BreadcrumbChain ?? new List<BreadcrumbItem>();
}

<div class="space-y-4">
    <div class="flex flex-col gap-2">

        @* パンくずナビ（タイトルの上） *@
        <nav aria-label="Breadcrumb" class="text-sm text-base-content/60">
            <ol class="flex flex-wrap items-center gap-1.5">
                <li>
                    <a class="link link-hover"
                       asp-controller="Dashboard"
                       asp-action="Index">Dashboard</a>
                </li>
                @foreach (var crumb in breadcrumbs)
                {
                    <li aria-hidden="true">/</li>
                    <li>
                        <a class="link link-hover" href="@crumb.Url">@crumb.Label</a>
                    </li>
                }
                <li aria-hidden="true">/</li>
                <li class="font-semibold text-base-content">@title</li>
            </ol>
        </nav>

        @* Newボタン（モーダル） + タイトル。"New Page" は _List.cshtml 内に移動（HTMX でstate付きURLを維持するため） *@
        <div class="flex items-center gap-3">
            <button class="btn btn-primary btn-sm"
                hx-get="@Url.Action("CreateForm", "DynamicEntity", new { entity = Model.Entity, mode = "modal", returnUrl = Model.ReturnUrl })"
                hx-target="#modal-form-content"
                hx-swap="innerHTML">
                New
            </button>
            <h1 class="text-2xl font-bold">@title</h1>
        </div>

        @if (!string.IsNullOrEmpty(Model.ReturnUrl))
        {
            <div class="flex items-center gap-2 text-sm text-base-content/70">
                <a class="btn btn-ghost btn-sm" href="@Model.ReturnUrl">
                    ← 前の@(Model.ReturnDisplayName ?? Model.ReturnEntity ?? "一覧")に戻る
                </a>
                <span>状態を維持したまま戻る</span>
            </div>
        }
    </div>

    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <form id="filter-form"
                  class="grid grid-cols-1 @filterColClass gap-3"
                  hx-get="@Url.Action("ListPartial", "DynamicEntity")"
                  hx-target="#list-container"
                  hx-swap="innerHTML">
                <input type="hidden" name="entity" value="@Model.Entity" />
                <input type="hidden" name="count" value="@(Model.CountEnabled ? "true" : "false")" />
                <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />

                <label class="input input-bordered col-span-full">
                    <span class="label">Search</span>
                    <input type="text" name="search" value="@Model.Search" placeholder="Search..." />
                </label>

                @foreach (var f in orderedFilters)
                {
                    var name = f.Key;
                    var def = f.Value;
                    <div>
                        <div class="label text-sm">@def.GetLabel(name)</div>
                        @await Html.PartialAsync("_FilterControl", (name, def, Model.Filters ?? new Dictionary<string, string?>()))
                    </div>
                }

                <div class="col-span-full">
                    <button type="submit" class="btn btn-outline">Search</button>
                </div>
            </form>
        </div>
    </div>

    <dialog id="entity-form-modal" class="modal">
        <div class="modal-box max-w-3xl">
            <div id="modal-form-content"></div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <div id="list-container"
         hx-get="@Url.Action("ListPartial", "DynamicEntity", new { entity = Model.Entity, search = Model.Search, sort = Model.Sort, dir = Model.Dir, count = Model.CountEnabled ? "true" : "false", cursor = Model.Cursor, returnUrl = Model.ReturnUrl })"
         hx-include="#filter-form"
         hx-trigger="load"
         hx-target="#list-container"
         hx-swap="innerHTML"></div>
</div>

@section Scripts {
    <script>
        document.body.addEventListener("htmx:afterSwap", function (evt) {
            if (evt.target && evt.target.id === "modal-form-content") {
                const dlg = document.getElementById("entity-form-modal");
                if (dlg && typeof dlg.showModal === "function") {
                    dlg.showModal();
                }
            }
        });

        document.body.addEventListener("entity-form-saved", function () {
            const dlg = document.getElementById("entity-form-modal");
            const content = document.getElementById("modal-form-content");
            if (dlg && typeof dlg.close === "function") {
                dlg.close();
            }
            if (content) {
                content.innerHTML = "";
            }
        });
    </script>
}
