@using DynamicCrudSample.Models
@model DynamicCrudSample.Controllers.DynamicListViewModel
@{
    var title = Model.Meta.GetDisplayName();
    ViewData["Title"] = title;
    ViewBag.ForeignKeyData = Model.ForeignKeyData;
    var filterCols = Math.Clamp(Model.Meta.Layout.Filters.Columns, 1, 6);
    var filterColClass = $"md:grid-cols-{filterCols}";
    var orderedFilters = Model.Meta.GetOrderedFilters().ToList();
}

<div class="space-y-4">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">@title</h1>
        <div class="flex gap-2">
            <button class="btn btn-primary"
                    hx-get="@Url.Action("CreateForm", "DynamicEntity", new { entity = Model.Entity, mode = "modal" })"
                    hx-target="#modal-form-content"
                    hx-swap="innerHTML">
                New
            </button>
            <a class="btn btn-outline"
               href="@Url.Action("CreatePage", "DynamicEntity", new { entity = Model.Entity })">
                New Page
            </a>
        </div>
    </div>

    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <form id="filter-form"
                  class="grid @filterColClass gap-3"
                  hx-get="@Url.Action("ListPartial", "DynamicEntity")"
                  hx-target="#list-container"
                  hx-swap="innerHTML">
                <input type="hidden" name="entity" value="@Model.Entity" />
                <input type="hidden" name="count" value="@(Model.CountEnabled ? "true" : "false")" />

                <label class="input input-bordered md:col-span-2">
                    <span class="label">Search</span>
                    <input type="text" name="search" value="@Model.Search" placeholder="Search..." />
                </label>

                @foreach (var f in orderedFilters)
                {
                    var name = f.Key;
                    var def = f.Value;
                    <div>
                        <div class="label text-sm">@def.GetLabel(name)</div>
                        @await Html.PartialAsync("_FilterControl", (name, def, Model.Filters ?? new Dictionary<string, string?>()))
                    </div>
                }

                <div class="md:col-span-4">
                    <button type="submit" class="btn btn-outline">Search</button>
                </div>
            </form>
        </div>
    </div>

    <dialog id="entity-form-modal" class="modal">
        <div class="modal-box max-w-3xl">
            <div id="modal-form-content"></div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <div id="list-container"
         hx-get="@Url.Action("ListPartial", "DynamicEntity", new { entity = Model.Entity, search = Model.Search, sort = Model.Sort, dir = Model.Dir, count = Model.CountEnabled ? "true" : "false", cursor = Model.Cursor })"
         hx-trigger="load"
         hx-target="#list-container"
         hx-swap="innerHTML"></div>
</div>

@section Scripts {
    <script>
        document.body.addEventListener("htmx:afterSwap", function (evt) {
            if (evt.target && evt.target.id === "modal-form-content") {
                const dlg = document.getElementById("entity-form-modal");
                if (dlg && typeof dlg.showModal === "function") {
                    dlg.showModal();
                }
            }
        });

        document.body.addEventListener("entity-form-saved", function () {
            const dlg = document.getElementById("entity-form-modal");
            const content = document.getElementById("modal-form-content");
            if (dlg && typeof dlg.close === "function") {
                dlg.close();
            }
            if (content) {
                content.innerHTML = "";
            }
        });
    </script>
}
