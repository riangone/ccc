@* ファイル概要: 動的フォーム（モーダル/ページ両対応）を描画します。
   このビューは画面表示と操作導線を担当します。
   データバインディング名や hx-* 属性を変更する場合は、コントローラ側との整合を必ず確認してください。 *@

@using Microsoft.AspNetCore.Routing
@model DynamicCrudSample.Controllers.DynamicFormViewModel
@{
    var itemDict = Model.Item as IDictionary<string, object>;
    var isEdit = itemDict != null;
    var action = isEdit ? "Edit" : "Create";
    var isPageMode = Model.Mode.Equals("page", StringComparison.OrdinalIgnoreCase);
    var formCols = Math.Clamp(Model.Meta.Layout.Forms.Columns, 1, 4);
    var formColClass = $"md:grid-cols-{formCols}";
    var orderedForms = Model.Meta.GetOrderedForms().ToList();
    var routeValues = new RouteValueDictionary();
    routeValues["entity"] = Model.Entity;
    if (isEdit && itemDict != null && itemDict.TryGetValue(Model.Meta.Key, out var routeId))
    {
        routeValues["id"] = routeId;
    }
}

<div class="card bg-base-100 shadow">
    <div class="card-body">
        <h2 class="card-title">@Model.Meta.GetDisplayName() - @(isEdit ? "Edit" : "Create")</h2>

        @if (isPageMode)
        {
            <form class="grid @formColClass gap-4"
                  method="post"
                  action="@Url.Action(action, "DynamicEntity", routeValues)">
                <input type="hidden" name="mode" value="@Model.Mode" />
                <input type="hidden" name="returnUrl" value="@Context.Request.Query["returnUrl"]" />
                @foreach (var field in orderedForms)
                {
                    var name = field.Key;
                    var def = field.Value;
                    if (def.Identity)
                    {
                        continue;
                    }

                    object? value = null;
                    if (isEdit && itemDict != null && itemDict.TryGetValue(name, out var rawValue))
                    {
                        value = rawValue;
                    }

                    var label = def.GetLabel(name);
                    var error = Model.Errors.ContainsKey(name) ? Model.Errors[name] : null;

                    <div>
                        <label class="label"><span class="label-text">@label</span></label>

                        @if (!def.Editable)
                        {
                            <input type="text" name="@name" value="@(value ?? "")" class="input input-bordered w-full" readonly disabled />
                        }
                        else if (def.ForeignKey != null && def.ForeignKey.Picker)
                        {
                            @* 単一選択ピッカー *@
                            var fkId = value?.ToString() ?? "";
                            var fkLabel = fkId;
                            if (!string.IsNullOrEmpty(fkId) && Model.ForeignKeyData.TryGetValue(name, out var fkPickItems))
                            {
                                foreach (var fkItem in fkPickItems)
                                {
                                    var d = (IDictionary<string, object>)fkItem;
                                    if (d.TryGetValue("Id", out var rawId) && rawId?.ToString() == fkId)
                                    {
                                        fkLabel = d.TryGetValue(def.ForeignKey.DisplayColumn, out var lv) ? lv?.ToString() ?? fkId : fkId;
                                        break;
                                    }
                                }
                            }
                            <div class="flex gap-2 items-center">
                                <input type="hidden" name="@name" id="picker-value-@name" value="@fkId" />
                                <input type="text" id="picker-display-@name" class="input input-bordered flex-1"
                                       readonly placeholder="Browse で選択..." value="@fkLabel" />
                                <button type="button" class="btn btn-outline btn-sm"
                                        data-picker-field="@name"
                                        data-picker-entity="@def.ForeignKey.Entity"
                                        data-picker-display-col="@def.ForeignKey.DisplayColumn"
                                        data-picker-multi="false"
                                        onclick="openEntityPicker(this)">
                                    Browse...
                                </button>
                                @if (!string.IsNullOrEmpty(fkId))
                                {
                                    <button type="button" class="btn btn-ghost btn-sm"
                                            onclick="clearPickerValue('@name')">✕</button>
                                }
                            </div>
                        }
                        else if (def.ForeignKey != null && def.ForeignKey.MultiPicker)
                        {
                            @* 複数選択ピッカー *@
                            var rawIds = (value?.ToString() ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                            var chipLabels = new Dictionary<string, string>();
                            if (Model.ForeignKeyData.TryGetValue(name, out var fkMultiItems))
                            {
                                foreach (var fkItem in fkMultiItems)
                                {
                                    var d = (IDictionary<string, object>)fkItem;
                                    if (d.TryGetValue("Id", out var rawId) && rawId != null)
                                    {
                                        var sid = rawId.ToString()!;
                                        var lbl = d.TryGetValue(def.ForeignKey.DisplayColumn, out var lv) ? lv?.ToString() ?? sid : sid;
                                        chipLabels[sid] = lbl;
                                    }
                                }
                            }
                            <div>
                                <div id="picker-chips-@name" class="flex flex-wrap gap-1 mb-2 min-h-8">
                                    @foreach (var pid in rawIds)
                                    {
                                        var chipLbl = chipLabels.TryGetValue(pid, out var cl) ? cl : pid;
                                        <div class="badge badge-neutral gap-1" data-id="@pid">
                                            @chipLbl
                                            <button type="button"
                                                    onclick="removePickerChip('@name', '@pid', this.parentElement)">✕</button>
                                        </div>
                                    }
                                </div>
                                <input type="hidden" name="@name" id="picker-value-@name" value="@(value?.ToString() ?? "")" />
                                <button type="button" class="btn btn-outline btn-sm"
                                        data-picker-field="@name"
                                        data-picker-entity="@def.ForeignKey.Entity"
                                        data-picker-display-col="@def.ForeignKey.DisplayColumn"
                                        data-picker-multi="true"
                                        onclick="openEntityPicker(this)">
                                    + Browse...
                                </button>
                            </div>
                        }
                        else if (def.ForeignKey != null && Model.ForeignKeyData.TryGetValue(name, out var fkItems))
                        {
                            <select name="@name" class="select select-bordered w-full">
                                <option value="">-- select --</option>
                                @foreach (var fk in fkItems)
                                {
                                    var dict = (IDictionary<string, object>)fk;
                                    var id = dict["Id"];
                                    var text = dict[def.ForeignKey.DisplayColumn];
                                    bool selected = (value != null && value.Equals(id));
                                    <option value="@id" selected="@(selected ? "selected" : null)">@text</option>
                                }
                            </select>
                        }
                        else if (def.Type.Equals("bool", StringComparison.OrdinalIgnoreCase))
                        {
                            bool checkedValue = value is bool b && b;
                            <input type="checkbox" name="@name" class="checkbox" checked="@(checkedValue ? "checked" : null)" />
                        }
                        else if (def.Options != null && def.Options.Any() && !def.Type.Equals("radio", StringComparison.OrdinalIgnoreCase))
                        {
                            var current = value?.ToString();
                            <select name="@name" class="select select-bordered w-full">
                                <option value="">-- select --</option>
                                @foreach (var opt in def.Options)
                                {
                                    <option value="@opt" selected="@(current == opt ? "selected" : null)">@opt</option>
                                }
                            </select>
                        }
                        else if (def.Type.Equals("int", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="number" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("decimal", StringComparison.OrdinalIgnoreCase) || def.Type.Equals("double", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="number" step="0.01" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("datetime", StringComparison.OrdinalIgnoreCase))
                        {
                            string v = value is DateTime dt ? dt.ToString("yyyy-MM-dd") : "";
                            <input type="date" name="@name" value="@v" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("date", StringComparison.OrdinalIgnoreCase))
                        {
                            string v = value is DateTime dt ? dt.ToString("yyyy-MM-dd") : value?.ToString() ?? "";
                            <input type="date" name="@name" value="@v" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("email", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="email" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("textarea", StringComparison.OrdinalIgnoreCase))
                        {
                            <textarea name="@name" class="textarea textarea-bordered w-full" rows="4">@(value ?? "")</textarea>
                        }
                        else if (def.Type.Equals("radio", StringComparison.OrdinalIgnoreCase) && def.Options != null)
                        {
                            var current = value?.ToString();
                            <div class="flex gap-4 flex-wrap">
                                @foreach (var opt in def.Options)
                                {
                                    <label class="label cursor-pointer gap-2">
                                        <input type="radio" name="@name" value="@opt" class="radio radio-sm" checked="@(current == opt ? "checked" : null)" />
                                        <span class="label-text">@opt</span>
                                    </label>
                                }
                            </div>
                        }
                        else
                        {
                            <input type="text" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }

                        @if (!string.IsNullOrEmpty(error))
                        {
                            <span class="text-error text-sm">@error</span>
                        }
                    </div>
                }

                <div class="md:col-span-2 flex gap-2">
                    <button type="submit" class="btn btn-primary">@(isEdit ? "Update" : "Create")</button>
                    <a class="btn btn-ghost" href="@Url.Action("Index", "DynamicEntity", new { entity = Model.Entity })">Cancel</a>
                </div>
            </form>
        }
        else
        {
            <form class="grid @formColClass gap-4"
                  hx-post="@Url.Action(action, "DynamicEntity", routeValues)"
                  hx-target="#modal-form-content"
                  hx-swap="innerHTML">
                <input type="hidden" name="mode" value="@Model.Mode" />
                <input type="hidden" name="returnUrl" value="@Context.Request.Query["returnUrl"]" />
                @foreach (var field in orderedForms)
                {
                    var name = field.Key;
                    var def = field.Value;
                    if (def.Identity)
                    {
                        continue;
                    }

                    object? value = null;
                    if (isEdit && itemDict != null && itemDict.TryGetValue(name, out var rawValue))
                    {
                        value = rawValue;
                    }

                    var label = def.GetLabel(name);
                    var error = Model.Errors.ContainsKey(name) ? Model.Errors[name] : null;

                    <div>
                        <label class="label"><span class="label-text">@label</span></label>

                        @if (!def.Editable)
                        {
                            <input type="text" name="@name" value="@(value ?? "")" class="input input-bordered w-full" readonly disabled />
                        }
                        else if (def.ForeignKey != null && def.ForeignKey.Picker)
                        {
                            @* 単一選択ピッカー *@
                            var fkId = value?.ToString() ?? "";
                            var fkLabel = fkId;
                            if (!string.IsNullOrEmpty(fkId) && Model.ForeignKeyData.TryGetValue(name, out var fkPickItems))
                            {
                                foreach (var fkItem in fkPickItems)
                                {
                                    var d = (IDictionary<string, object>)fkItem;
                                    if (d.TryGetValue("Id", out var rawId) && rawId?.ToString() == fkId)
                                    {
                                        fkLabel = d.TryGetValue(def.ForeignKey.DisplayColumn, out var lv) ? lv?.ToString() ?? fkId : fkId;
                                        break;
                                    }
                                }
                            }
                            <div class="flex gap-2 items-center">
                                <input type="hidden" name="@name" id="picker-value-@name" value="@fkId" />
                                <input type="text" id="picker-display-@name" class="input input-bordered flex-1"
                                       readonly placeholder="Browse で選択..." value="@fkLabel" />
                                <button type="button" class="btn btn-outline btn-sm"
                                        data-picker-field="@name"
                                        data-picker-entity="@def.ForeignKey.Entity"
                                        data-picker-display-col="@def.ForeignKey.DisplayColumn"
                                        data-picker-multi="false"
                                        onclick="openEntityPicker(this)">
                                    Browse...
                                </button>
                                @if (!string.IsNullOrEmpty(fkId))
                                {
                                    <button type="button" class="btn btn-ghost btn-sm"
                                            onclick="clearPickerValue('@name')">✕</button>
                                }
                            </div>
                        }
                        else if (def.ForeignKey != null && def.ForeignKey.MultiPicker)
                        {
                            @* 複数選択ピッカー *@
                            var rawIds = (value?.ToString() ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                            var chipLabels = new Dictionary<string, string>();
                            if (Model.ForeignKeyData.TryGetValue(name, out var fkMultiItems))
                            {
                                foreach (var fkItem in fkMultiItems)
                                {
                                    var d = (IDictionary<string, object>)fkItem;
                                    if (d.TryGetValue("Id", out var rawId) && rawId != null)
                                    {
                                        var sid = rawId.ToString()!;
                                        var lbl = d.TryGetValue(def.ForeignKey.DisplayColumn, out var lv) ? lv?.ToString() ?? sid : sid;
                                        chipLabels[sid] = lbl;
                                    }
                                }
                            }
                            <div>
                                <div id="picker-chips-@name" class="flex flex-wrap gap-1 mb-2 min-h-8">
                                    @foreach (var pid in rawIds)
                                    {
                                        var chipLbl = chipLabels.TryGetValue(pid, out var cl) ? cl : pid;
                                        <div class="badge badge-neutral gap-1" data-id="@pid">
                                            @chipLbl
                                            <button type="button"
                                                    onclick="removePickerChip('@name', '@pid', this.parentElement)">✕</button>
                                        </div>
                                    }
                                </div>
                                <input type="hidden" name="@name" id="picker-value-@name" value="@(value?.ToString() ?? "")" />
                                <button type="button" class="btn btn-outline btn-sm"
                                        data-picker-field="@name"
                                        data-picker-entity="@def.ForeignKey.Entity"
                                        data-picker-display-col="@def.ForeignKey.DisplayColumn"
                                        data-picker-multi="true"
                                        onclick="openEntityPicker(this)">
                                    + Browse...
                                </button>
                            </div>
                        }
                        else if (def.ForeignKey != null && Model.ForeignKeyData.TryGetValue(name, out var fkItems))
                        {
                            <select name="@name" class="select select-bordered w-full">
                                <option value="">-- select --</option>
                                @foreach (var fk in fkItems)
                                {
                                    var dict = (IDictionary<string, object>)fk;
                                    var id = dict["Id"];
                                    var text = dict[def.ForeignKey.DisplayColumn];
                                    bool selected = (value != null && value.Equals(id));
                                    <option value="@id" selected="@(selected ? "selected" : null)">@text</option>
                                }
                            </select>
                        }
                        else if (def.Type.Equals("bool", StringComparison.OrdinalIgnoreCase))
                        {
                            bool checkedValue = value is bool b && b;
                            <input type="checkbox" name="@name" class="checkbox" checked="@(checkedValue ? "checked" : null)" />
                        }
                        else if (def.Options != null && def.Options.Any() && !def.Type.Equals("radio", StringComparison.OrdinalIgnoreCase))
                        {
                            var current = value?.ToString();
                            <select name="@name" class="select select-bordered w-full">
                                <option value="">-- select --</option>
                                @foreach (var opt in def.Options)
                                {
                                    <option value="@opt" selected="@(current == opt ? "selected" : null)">@opt</option>
                                }
                            </select>
                        }
                        else if (def.Type.Equals("int", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="number" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("decimal", StringComparison.OrdinalIgnoreCase) || def.Type.Equals("double", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="number" step="0.01" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("datetime", StringComparison.OrdinalIgnoreCase))
                        {
                            string v = value is DateTime dt ? dt.ToString("yyyy-MM-dd") : "";
                            <input type="date" name="@name" value="@v" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("date", StringComparison.OrdinalIgnoreCase))
                        {
                            string v = value is DateTime dt ? dt.ToString("yyyy-MM-dd") : value?.ToString() ?? "";
                            <input type="date" name="@name" value="@v" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("email", StringComparison.OrdinalIgnoreCase))
                        {
                            <input type="email" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }
                        else if (def.Type.Equals("textarea", StringComparison.OrdinalIgnoreCase))
                        {
                            <textarea name="@name" class="textarea textarea-bordered w-full" rows="4">@(value ?? "")</textarea>
                        }
                        else if (def.Type.Equals("radio", StringComparison.OrdinalIgnoreCase) && def.Options != null)
                        {
                            var current = value?.ToString();
                            <div class="flex gap-4 flex-wrap">
                                @foreach (var opt in def.Options)
                                {
                                    <label class="label cursor-pointer gap-2">
                                        <input type="radio" name="@name" value="@opt" class="radio radio-sm" checked="@(current == opt ? "checked" : null)" />
                                        <span class="label-text">@opt</span>
                                    </label>
                                }
                            </div>
                        }
                        else
                        {
                            <input type="text" name="@name" value="@(value ?? "")" class="input input-bordered w-full" />
                        }

                        @if (!string.IsNullOrEmpty(error))
                        {
                            <span class="text-error text-sm">@error</span>
                        }
                    </div>
                }

                <div class="md:col-span-2 flex gap-2">
                    <button type="submit" class="btn btn-primary">@(isEdit ? "Update" : "Create")</button>
                    <button type="button" class="btn btn-ghost" onclick="document.getElementById('entity-form-modal')?.close();">Cancel</button>
                </div>
            </form>
        }
    </div>
</div>
